---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, getEntry } from "astro:content";
import styles from "../../components/islands/Feed.module.css";

export async function getStaticPaths() {
	const allPosts = await getCollection("posts");
	// Only generate pages for posts with show: true
	const visiblePosts = allPosts.filter((post) => post.data.show === true);
	return visiblePosts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = await getEntry("posts", slug);

// If post doesn't exist or has show: false, return 404
if (!post || post.data.show !== true) {
	return new Response("Post not found or not visible", { status: 404 });
}

const rendered = await post.render();

// Convert dateCreated to a JS Date object at build time
const dateCreated = new Date(post.data.dateCreated);
---

<BaseLayout>
	<!-- Use same feed layout wrapper to match card styles -->
	<ul id="posts-feed">
		<li class={`${styles["post-card"]} expanded-card`}>
			<div class={styles["post-card-inner"] + " flex-col gap-lg"}>
				{
					(post.data.type === "game" || post.data.type === "play") &&
						post.data.slug && (
							<div
								class={
									styles["post-card-thumbnail"] +
									" mb-0 mr-lg flex items-center"
								}
							>
								<img
									src={`/games/${post.data.slug}/thumbnail.png`}
									alt={`Thumbnail for ${post.data.title}`}
									class={`${styles["post-thumb-large"]} block`}
									loading="lazy"
									onerror="this.style.display='none'"
								/>
							</div>
						)
				}
				<!-- New expandable embed card -->
				{
					(post.data.type === "game" || post.data.type === "play") &&
						post.data.slug && (
							<div class={styles["post-card"] + " w-full mb-lg flex-col"}>
								<div class={styles["post-card-inner"] + " flex-col p-md"}>
									<button
										id="toggle-embedded-game"
										class="feed-cta pill mb-md"
									>
										Show Embedded Game
									</button>
									<div
										id="embedded-game-container"
										class="w-full hidden"
									>
										<iframe
											src={`/games/${post.data.slug}/index.html`}
											title={`Embedded game: ${post.data.title}`}
											class="w-full min-h-embed rounded-unified border-unified shadow-unified mt-lg bg-card"
											loading="lazy"
											allowfullscreen
										/>
									</div>
								</div>
							</div>
						)
				}

				<article class={styles["post-card-content"]}>
					<button
						onclick="history.back()"
						class="feed-cta pill mb-lg"
						>‚Üê Back</button
					>
					<a
						href={Astro.url.pathname}
						data-testid="feed-post-link"
						class="post-title block font-lg font-bold color-title mb-xs break-word"
					>
						{post.data.title}
					</a>
					<div class="post-date color-muted mb-xs min-h-date">
						{dateCreated ? `Created: ${dateCreated.toLocaleDateString()}` : ""}
					</div>
					{
						post.data.description && (
							<div class={styles["post-description"] + " mb-xs"}>
								{post.data.description}
							</div>
						)
					}
					<div class="post-content">
						<rendered.Content />
					</div>
				</article>
			</div>
		</li>
	</ul>
	<script is:inline>
		const toggleBtn = document.getElementById("toggle-embedded-game");
		const embeddedContainer = document.getElementById(
			"embedded-game-container"
		);
		if (toggleBtn && embeddedContainer) {
			toggleBtn.addEventListener("click", () => {
				embeddedContainer.classList.toggle("hidden");
				toggleBtn.textContent =
					embeddedContainer.classList.contains("hidden") ?
						"Show Embedded Game"
					:	"Hide Embedded Game";
			});
		}
	</script>
</BaseLayout>
